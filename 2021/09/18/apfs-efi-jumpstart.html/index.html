<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Apple File Systemの下にはEFI driverが埋まっている - retrage.github.io</title>
<meta name=theme-color><meta name=description content="Apple File Systemの下にはEFI driverが埋まっている Apple File System (APFS)はAppleが自社製品向けに開発したファイルシステムである．APF"><meta name=author content="Akira Moroo"><link rel="preload stylesheet" as=style href=https://retrage.github.io/main.min.css><script defer src=https://retrage.github.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=preload as=image href=https://retrage.github.io/theme.png><link rel=preload as=image href=https://github.com/retrage.png><link rel=preload as=image href=https://retrage.github.io/twitter.svg><link rel=preload as=image href=https://retrage.github.io/github.svg><link rel=preload as=image href=https://retrage.github.io/rss.svg><link rel=icon href=https://retrage.github.io/favicon.ico><link rel=apple-touch-icon href=https://retrage.github.io/apple-touch-icon.png><meta name=generator content="Hugo 0.130.0"><meta itemprop=name content="Apple File Systemの下にはEFI driverが埋まっている"><meta itemprop=description content="Apple File Systemの下にはEFI driverが埋まっている Apple File System (APFS)はAppleが自社製品向けに開発したファイルシステムである．APF"><meta itemprop=datePublished content="2021-09-18T17:41:01+00:00"><meta itemprop=dateModified content="2021-09-18T17:41:01+00:00"><meta itemprop=wordCount content="2107"><meta name=twitter:card content="summary"><meta name=twitter:title content="Apple File Systemの下にはEFI driverが埋まっている"><meta name=twitter:description content="Apple File Systemの下にはEFI driverが埋まっている Apple File System (APFS)はAppleが自社製品向けに開発したファイルシステムである．APF"></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=https://retrage.github.io/>retrage.github.io</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/>Posts</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/retrage target=_blank rel=me>twitter
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/retrage target=_blank rel=me>github
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://retrage.github.io/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"><article><header class=mb-16><h1 class="!my-0 pb-2.5">Apple File Systemの下にはEFI driverが埋まっている</h1><div class="text-sm antialiased opacity-60"><time>Sep 18, 2021</time></div></header><section><h1 id=apple-file-systemの下にはefi-driverが埋まっている>Apple File Systemの下にはEFI driverが埋まっている</h1><p>Apple File System (APFS)はAppleが自社製品向けに開発したファイルシステムである．APFSの仕様は公開されており以下で参照できる．</p><ul><li><a href=https://developer.apple.com/support/downloads/Apple-File-System-Reference.pdf>https://developer.apple.com/support/downloads/Apple-File-System-Reference.pdf</a></li></ul><p>その目次の中で特に興味を引いたのが"EFI Jumpstart"の章である．現代的なデバイスではEFIを含めブートローダはファイルシステムを参照してOSを起動する．このとき当然ながらブートローダはそのファイルシステムを扱える必要がある．特にEFIでは仕様上対応していなければならないのはEFI System Partition (ESP)で使われるFATのみでその他のファイルシステムが事前にサポートされていることは期待できない．このため例えばWindowsであればESPに配置されたWindows専用のブートローダがNTFSをサポートすることでカーネルの起動を行なっている．</p><p>これに対してmacOSではAPFS自身がAPFSのEFI driverをパーティションのブロックに直接埋め込む形で提供するという別のアプローチをとっている．ドキュメントによれば</p><blockquote><p>This design intentionally simplifies the steps needed to boot, which means the code needed to boot a piece of hardware or virtualization software can likewise be simpler.</p></blockquote><p>とのことで起動プロセスをシンプルにすることが目的のようである．</p><p>どのようにEFI driverが埋め込まれているのかをみていく．
最初の前提としてディスクのGPTエントリを読み，以下のUUIDのようなAPFSのパーティションがあることがわかったとする．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#define APFS_GPT_PARTITION_UUID ”7C3457EF-0000-11AA-AA11-00306543ECAC”
</span></span></span></code></pre></div><p>APFSパーティションは一つのAPFS containerオブジェクトとして存在し，その先頭にcontainerの情報を持ったcontainer superblockが配置されている．</p><p>container superblockを表す<code>nx_superblock_t</code>には<code>nx_efi_jumpstart</code>というEFI Jumpstartの情報を持った<code>nx_efi_jumpstart_t</code>への物理アドレス(containerの先頭からのAPFSでのブロックサイズ単位でのオフセット)のフィールドが用意されている．</p><p>その参照先には以下のような<code>nx_efi_jumpstart_t</code>がある．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  obj_phys_t  nej_o;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uint32_t</span>    nej_magic;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uint32_t</span>    nej_version;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uint32_t</span>    nej_efi_file_len;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uint32_t</span>    nej_num_extents;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uint64_t</span>    nej_reserved[<span style=color:#ae81ff>16</span>];
</span></span><span style=display:flex><span>  prange_t    nej_rec_extents[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>} nx_efi_jumpstart_t;
</span></span></code></pre></div><p>この<code>nej_rec_extents</code>にあるブロックを読むことでAPFSパーティションに直接埋め込まれたEFI driverを読み込むことができる．</p><p>ユーザ空間で以上のようなことを行いraw disk imageからEFI driverを抽出する簡単なアプリケーションを実装した．本来は色々と検証を行う必要があるが，ここでは省略した．</p><ul><li><a href=https://gist.github.com/retrage/9087102e28c70a383f96684ecdf09a83>https://gist.github.com/retrage/9087102e28c70a383f96684ecdf09a83</a></li></ul><p>抽出したバイナリは以下のように確かにPE32+のEFI driverとして認識されている．</p><pre tabindex=0><code>$ file apfs.efi
apfs.efi: PE32+ executable (EFI boot service driver) x86-64 (stripped to external PDB), for MS Windows
</code></pre><p>せっかくなので抜き出したEFI driverを覗いてみる．バイナリのハッシュは<code>1e780147f2cee614ab7e9a63c4e86525f06c5a18d72a6b8ec572752ffd95dea0</code>である．<code>.debug</code>セクションの指す<code>9E9FCh</code>をみると"MTOC"の文字列と"apfs.efi.macho"という文字列が見えるのでこのバイナリの名前は"apfs.efi"でMach-OバイナリをApple謹製のmtocでPE32+に変換して生成されたようである．</p><p>ちなみにClover EFI bootloaderでは先にたどっていったような手順でapfs.efiをロードするEFI driverがあり，これでAPFS対応を行なっているようである．</p><p><a href=https://sourceforge.net/p/cloverefiboot/code/HEAD/tree/FileSystems/ApfsDriverLoader/>https://sourceforge.net/p/cloverefiboot/code/HEAD/tree/FileSystems/ApfsDriverLoader/</a></p><p>話を元に戻してバイナリをみていくと，<code>.text</code>セクションの先頭に"2021/08/30"や"06:36:21"のような日時があるのでこれがこのバイナリがビルドされた日時だと考えられる．対象としたmacOS Bit Sur 11.6は2021年9月13日にリリースされたので少なくとも2週間程度前にはビルドされたようである．
他にもみどころはたくさんありそうだがこれぐらいにしておく．</p><p>以上はIntel Mac上での話である．ではARM64ベースのm1 Macの場合はどうだろうか？</p><pre tabindex=0><code>$ uname -a
Darwin 7261.local 20.5.0 Darwin Kernel Version 20.5.0: Sat May  8 05:10:31 PDT 2021; root:xnu-7195.121.3~9/RELEASE_ARM64_T8101 arm64
$ ./dumper ~/Desktop/recovery.img
superblock at 280000000
nx_block_size: 0x1000
nx_block_count: 0x13fff5
nx_efi_jumpstart: 0x0
APFS EFI Jumpstart not found
</code></pre><p>残念ながら答えは否のようである．すでに広く知られているように，m1 MacではEFIではなくiPhoneなどと同じiBootから起動するカスタマイズされたファームウェアであるため，サードパーティでの実行環境を考慮しなければEFI Jumpstartの機能は不要であるためだと考えられる．へその緒のようにあったら面白かったのだが．ということでm1 MacのAPFSでは<code>nx_efi_jumpstart_t</code>の<code>nx_efi_jumpstart</code>は使われないフィールドとなってしまったようである．</p><p>というわけでIntel MacのAPFSの下にはEFI driverが埋まっているのでIntel Macをお持ちの方は酒宴でも開きましょう．</p></section><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://retrage.github.io/2022/01/16/allwinner-nezha-jtag.html/><span class=mr-1.5>←</span><span>Allwinner NezhaにJTAGで接続する</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://retrage.github.io/2020/08/01/9pfspkg-en.html/><span>9pfsPkg: Network Boot from Bell Labs</span><span class=ml-1.5>→</span></a></nav></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2024
<a class=link href=https://retrage.github.io/>retrage.github.io</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>✎ Paper</a></footer></body></html>