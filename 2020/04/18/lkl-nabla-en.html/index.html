<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=en-us dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Porting Linux to Nabla Containers - retrage.github.io</title>
<meta name=theme-color><meta name=description content="This is an introduction of Linux Kernel Library ported to Nabla Containers.
runnc
is an OCI runtime that runs process-level isolated unikernels.
It is built on the top of Solo5,
a sandbox for unikernels, and several unikernels (MirageOS, IncludeOS, Rumprun) run on it.
The original runnc uses Rumprun, a NetBSD based unikernel.
However, as Docker is started from Linux,
it is needed to have system call level compatibility with Linux.
Therefore, I ported Linux Kernel Library (LKL) and musl libc to Solo5
and put together with runnc."><meta name=author content="Akira Moroo"><link rel="preload stylesheet" as=style href=https://retrage.github.io/main.min.css><link rel=preload as=image href=https://retrage.github.io/theme.png><link rel=preload as=image href=https://github.com/retrage.png><link rel=preload as=image href=https://retrage.github.io/twitter.svg><link rel=preload as=image href=https://retrage.github.io/github.svg><link rel=preload as=image href=https://retrage.github.io/rss.svg><script defer src=https://retrage.github.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://retrage.github.io/favicon.ico><link rel=apple-touch-icon href=https://retrage.github.io/apple-touch-icon.png><meta name=generator content="Hugo 0.134.2"><meta itemprop=name content="Porting Linux to Nabla Containers"><meta itemprop=description content="This is an introduction of Linux Kernel Library ported to Nabla Containers.
runnc is an OCI runtime that runs process-level isolated unikernels. It is built on the top of Solo5, a sandbox for unikernels, and several unikernels (MirageOS, IncludeOS, Rumprun) run on it. The original runnc uses Rumprun, a NetBSD based unikernel. However, as Docker is started from Linux, it is needed to have system call level compatibility with Linux. Therefore, I ported Linux Kernel Library (LKL) and musl libc to Solo5 and put together with runnc."><meta itemprop=datePublished content="2020-04-18T17:10:13+00:00"><meta itemprop=dateModified content="2020-04-18T17:10:13+00:00"><meta itemprop=wordCount content="1053"><meta property="og:url" content="https://retrage.github.io/2020/04/18/lkl-nabla-en.html/"><meta property="og:site_name" content="retrage.github.io"><meta property="og:title" content="Porting Linux to Nabla Containers"><meta property="og:description" content="This is an introduction of Linux Kernel Library ported to Nabla Containers.
runnc is an OCI runtime that runs process-level isolated unikernels. It is built on the top of Solo5, a sandbox for unikernels, and several unikernels (MirageOS, IncludeOS, Rumprun) run on it. The original runnc uses Rumprun, a NetBSD based unikernel. However, as Docker is started from Linux, it is needed to have system call level compatibility with Linux. Therefore, I ported Linux Kernel Library (LKL) and musl libc to Solo5 and put together with runnc."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-04-18T17:10:13+00:00"><meta property="article:modified_time" content="2020-04-18T17:10:13+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Porting Linux to Nabla Containers"><meta name=twitter:description content="This is an introduction of Linux Kernel Library ported to Nabla Containers.
runnc is an OCI runtime that runs process-level isolated unikernels. It is built on the top of Solo5, a sandbox for unikernels, and several unikernels (MirageOS, IncludeOS, Rumprun) run on it. The original runnc uses Rumprun, a NetBSD based unikernel. However, as Docker is started from Linux, it is needed to have system call level compatibility with Linux. Therefore, I ported Linux Kernel Library (LKL) and musl libc to Solo5 and put together with runnc."><link rel=canonical href=https://retrage.github.io/2020/04/18/lkl-nabla-en.html/></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center"><div class="relative z-50 ltr:mr-auto rtl:ml-auto flex items-center"><a class="-translate-y-[1px] text-2xl font-medium" href=https://retrage.github.io/>retrage.github.io</a><div class="btn-dark text-[0] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 ltr:-mr-8 rtl:-ml-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a>
<a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>Posts</a></nav><nav class="mt-12 flex justify-center space-x-10 rtl:space-x-reverse dark:invert ltr:lg:ml-14 rtl:lg:mr-14 lg:mt-0 lg:items-center"><a class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/retrage target=_blank rel=me>twitter
</a><a class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/retrage target=_blank rel=me>github
</a><a class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://retrage.github.io/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"><article><header class=mb-14><h1 class="!my-0 pb-2.5">Porting Linux to Nabla Containers</h1><div class="text-xs antialiased opacity-60"><time>Apr 18, 2020</time></div></header><section><p>This is an introduction of Linux Kernel Library ported to Nabla Containers.</p><p><a href=https://github.com/nabla-containers/runnc.git>runnc</a>
is an OCI runtime that runs process-level isolated unikernels.
It is built on the top of <a href=https://github.com/Solo5/solo5>Solo5</a>,
a sandbox for unikernels, and several unikernels (MirageOS, IncludeOS, Rumprun) run on it.
The original runnc uses Rumprun, a NetBSD based unikernel.
However, as Docker is started from Linux,
it is needed to have system call level compatibility with Linux.
Therefore, I ported Linux Kernel Library (LKL) and musl libc to Solo5
and put together with runnc.</p><h2 id=frankenlibc-on-solo5>frankenlibc on Solo5</h2><p>frankenlibc is a set of tools to run Rump unikernels in various environments.
It has a fork that ported LKL and some libraries.
I used this frankenlibc fork and added Solo5 platform support.</p><ul><li><a href=https://github.com/retrage/frankenlibc/tree/solo5>https://github.com/retrage/frankenlibc/tree/solo5</a></li></ul><h3 id=building-frankenlibc>Building frankenlibc</h3><p>Clone the repository and checkout <code>solo5</code> branch.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ git clone https://github.com/retrage/frankenlibc.git
</span></span><span style=display:flex><span>$ cd frankenlibc
</span></span><span style=display:flex><span>$ git checkout solo5
</span></span></code></pre></div><p>Clone full Solo5 repository to avoid build failure and update submodules.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ git clone https://github.com/Solo5/solo5.git
</span></span><span style=display:flex><span>$ git submodule update --init
</span></span></code></pre></div><p>Apply some patches.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ <span style=color:#66d9ef>for</span> file in <span style=color:#e6db74>`</span>find patches/solo5/ -maxdepth <span style=color:#ae81ff>1</span> -type f<span style=color:#e6db74>`</span> ; <span style=color:#66d9ef>do</span> patch -p1 &lt; $file ; <span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>Finally, run the build script.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ ./build.sh -k linux notests solo5
</span></span></code></pre></div><p>You can find libraries and toolchain wrappers in <code>rump</code> directory
after building successfully.</p><h3 id=testing>Testing</h3><p>Even if <code>notests</code> specified, <code>build.sh</code> builds simple tests to <code>rumpobj/tests</code>.</p><p>Create a <code>tap100</code> tap device.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ sudo ip tuntap add tap100 mode tap
</span></span><span style=display:flex><span>$ sudo ip addr add 10.0.0.1/24 dev tap100
</span></span><span style=display:flex><span>$ sudo ip link set dev tap100 up
</span></span></code></pre></div><p>Create <code>disk.img</code> disk image.
As LKL/frankenlibc creates directories on initialization,
some operations fail if read-only ISO image is used.
To avoid this issue, we use the Ext4 file system image.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>disk.img bs<span style=color:#f92672>=</span><span style=color:#ae81ff>1024</span> count<span style=color:#f92672>=</span><span style=color:#ae81ff>20480</span>
</span></span><span style=display:flex><span>$ mkfs.ext4 -F disk.img
</span></span></code></pre></div><p>Note that Solo5 requires an application manifest on build time,
which is embedded in a unikernel binary.
In current frankenlibc Solo5 support, the manifest is common across binaries
and specifies <code>rootfs</code> block device and <code>tap</code> network device.
We have to provide these devices even not used in the applications.</p><ul><li><a href=https://github.com/retrage/frankenlibc/blob/solo5/platform/solo5/manifest.json>https://github.com/retrage/frankenlibc/blob/solo5/platform/solo5/manifest.json</a></li></ul><p>Run <code>hello</code> test.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ RUMP_VERBOSE<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ./rump/bin/rexec rumpobj/tests/hello rootfs:disk.img tap:tap100
</span></span></code></pre></div><p>In the Linux platform, <code>rexec</code> provides a sandbox environment for unikernels
using seccomp like Solo5&rsquo;s tenders.
In the Solo5 platform, it is just a shell script wrapper for <code>spt</code> tender.</p><h2 id=lkl-nabla-containers>LKL Nabla Containers</h2><p>Now, it&rsquo;s time to integrate with Nabla Containers.
Since the original runnc imports older version of Solo5,
I updated it and adapted the runnc code base.</p><ul><li><a href=https://github.com/retrage/runnc/tree/lkl-musl>https://github.com/retrage/runnc/tree/lkl-musl</a></li></ul><h3 id=updating-supplied-arguments>Updating Supplied Arguments</h3><p>Below is the original code that creates arguments for Solo5 tender.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mac</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>args</span> = []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>NablaRunBin</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--x-exec-heap&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--mem=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>FormatInt</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Memory</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--net-mac=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>mac</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--net=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Tap</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--disk=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>disk</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>UniKernelBin</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>unikernelArgs</span>}
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>args</span> = []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>NablaRunBin</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--x-exec-heap&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--mem=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>FormatInt</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Memory</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--net=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Tap</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--disk=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>disk</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>UniKernelBin</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>unikernelArgs</span>}
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>In the latest Solo5 (frankenlibc Solo5 platform uses),
<code>--net-mac</code> option is removed and we can specify multiple block devices
and network devices with <code>--block:</code> and <code>--net:</code> options.
Ideally, it should support multiple devices.
However, as described before, it can specify <code>rootfs</code> and <code>tap</code> only.
So, the port ends up with the support of these devices like this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> = []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>NablaRunBin</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--mem=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>FormatInt</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Memory</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--net:tap=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Tap</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--block:rootfs=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>disk</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>UniKernelBin</span>}
</span></span></code></pre></div><h3 id=creating-disk-image>Creating Disk Image</h3><p>I added <code>CreateExt4()</code> function and <code>llmodules/fs/ext4_storage.go</code>
to create Ext4 rootfs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// CreateExt4 creates ext4 raw disk image from the dir argument
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CreateExt4</span>(<span style=color:#a6e22e>dir</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>target</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>fname</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>TempFile</span>(<span style=color:#e6db74>&#34;/tmp&#34;</span>, <span style=color:#e6db74>&#34;nabla&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fname</span> = <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Close</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fname</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Abs</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>target</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Wrap</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Unable to resolve abs target path&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>absDir</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Abs</span>(<span style=color:#a6e22e>dir</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Wrap</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Unable to resolve abs dir path&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;virt-make-fs&#34;</span>, <span style=color:#e6db74>&#34;-F&#34;</span>, <span style=color:#e6db74>&#34;raw&#34;</span>, <span style=color:#e6db74>&#34;-t&#34;</span>, <span style=color:#e6db74>&#34;ext4&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>absDir</span>, <span style=color:#a6e22e>fname</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Run</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Wrap</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Unable to run virt-make-fs command&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fname</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>virt-make-fs</code>, a part of <a href=http://libguestfs.org/>libguestfs</a>
has similar interface with <code>genisoimage</code>.</p><p>It would be better to switch <code>NewISOFsHandler()</code> and <code>NewExt4FsHandler()</code> on run time.</p><h3 id=building-and-installing-runnc>Building and Installing runnc</h3><p>Same as original.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ git clone https://github.com/retrage/runnc.git
</span></span><span style=display:flex><span>$ mkdir -p $GOPATH/github.com/retrage
</span></span><span style=display:flex><span>$ ln -sf $PWD/runnc $GOPATH/github.com/retrage/runnc
</span></span><span style=display:flex><span>$ cd runnc
</span></span><span style=display:flex><span>$ git apply patches/0001-solo5-elf-segment-align-workaround.patch
</span></span><span style=display:flex><span>$ make build
</span></span><span style=display:flex><span>$ make install
</span></span></code></pre></div><h3 id=testing-with-docker-images>Testing with Docker Images</h3><p>I provided a set of Makefiles build LKL Nabla Container base Docker images.
It builds Solo5 and frankenlibc, and Docker images.</p><ul><li><a href=https://github.com/retrage/lkl-nabla-base-build>https://github.com/retrage/lkl-nabla-base-build</a></li></ul><p>I also pushed pre-built Docker images to Docker Hub.</p><ul><li><a href=https://hub.docker.com/repository/docker/retrage/lkl-nabla-hello-base>retrage/lkl-nabla-hello-base</a></li><li><a href=https://hub.docker.com/repository/docker/retrage/lkl-nabla-python3-base>retrage/lkl-nabla-python3-base</a></li></ul><p>You can use images like this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ sudo docker run --rm --runtime<span style=color:#f92672>=</span>runnc retrage/lkl-nabla-python3-base:
</span></span><span style=display:flex><span>latest -c &#34;print(\&#39;hello\&#39;)&#34;
</span></span><span style=display:flex><span>[sudo] password for akira:
</span></span><span style=display:flex><span>nabla-run arg [/opt/runnc/bin/nabla-run --mem=512 --net:tap=tap28157ba5950e --bl
</span></span><span style=display:flex><span>ock:rootfs=/var/run/docker/runtime-runnc/moby/28157ba5950e3e84824bd843fd1dafb06eccc7de2020a0619d6a5b463e5f2c2b/rootfs.img /var/lib/docker/overlay2/3d36c19950e53eefded8e1933f3d7e51990fc4c7b065be6c00776eeab8fb3136/merged/python3.nabla __RUMP_FDINFO_NET_tap=4 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin HOSTNAME=28157ba5950e PYTHONHASHSEED=1 PYTHONHOME=/usr/local HOME=/ -- -c print(\&#39;hello\&#39;)]
</span></span><span style=display:flex><span>            |      ___|
</span></span><span style=display:flex><span>  __|  _ \  |  _ \ __ \
</span></span><span style=display:flex><span>\__ \ (   | | (   |  ) |
</span></span><span style=display:flex><span>____/\___/ _|\___/____/
</span></span><span style=display:flex><span>Solo5: Bindings version v0.6.4-6-g756accf-dirty
</span></span><span style=display:flex><span>Solo5: Memory map: 512 MB addressable:
</span></span><span style=display:flex><span>Solo5:   reserved @ (0x0 - 0xfffff)
</span></span><span style=display:flex><span>Solo5:       text @ (0x100000 - 0x889fff)
</span></span><span style=display:flex><span>Solo5:     rodata @ (0x88a000 - 0xb4cfff)
</span></span><span style=display:flex><span>Solo5:       data @ (0xb4d000 - 0xe7dfff)
</span></span><span style=display:flex><span>Solo5:       heap &gt;= 0xe7e000 &lt; stack &lt; 0x20000000
</span></span><span style=display:flex><span>sleeping 50000 usec
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span>Solo5: solo5_exit(0) called
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>In this post, I introduced a brief of LKL Nabla Containers.
It is still in an early stage and has room for improvement,
but already runs practical applications like Python.
I would like to measure the performance and evaluate the pros/cons.</p><p>Below is the TODO list:</p><ul><li>Replace workaround for Solo5</li><li>Flexible <code>manifest.json</code> handling on build time</li><li><del>Pass <code>lkl.json</code> through run time arguments</del></li><li>Do not pass <code>__RUMP_FDINFO_NET_tap=4</code> environment variable on run time</li></ul><h2 id=update-may-1st-2020>Update: May 1st, 2020</h2><p>After wrote this post,
I found that LKL must use network information created by the container runtime.
Otherwise, the network does not work properly.
I added the 3rd feature described in the above TODO list to frankenlibc and runnc.</p><ul><li><a href=https://github.com/retrage/frankenlibc/commit/fb4fde66c73c8bec58d754249db77edb66537955>add external lkl json config support</a></li><li><a href=https://github.com/retrage/runnc/commit/e73c1203e8a1b19d4813917d893aec6181432e01>Create lkl config json</a></li></ul><p>The OCI runtime builds and passes JSON config for LKL at startup.
LKL parses it along with environment variables and arguments.</p><p>Now, popular network applications Nginx and redis work on LKL Nabla Containers.
They are available as base Docker Images.</p><ul><li><a href=https://hub.docker.com/repository/docker/retrage/lkl-nabla-nginx-base>retrage/lkl-nabla-nginx-base</a></li><li><a href=https://hub.docker.com/repository/docker/retrage/lkl-nabla-redis-base>retrage/lkl-nabla-redis-base</a></li></ul></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg !leading-[1.2] *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://retrage.github.io/2020/05/06/edk2-error-level.html/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>EDK2におけるDebugPrintErrorLevel</span></a>
<a class="ltr:ml-auto rtl:mr-auto justify-end pl-3" href=https://retrage.github.io/2020/03/04/ccov-introduction.html/><span>ccov: printfデバッグを支援するツール</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav></article></main><footer class="mx-auto flex h-[4.5rem] max-w-[--w] items-center px-8 text-xs uppercase tracking-wider opacity-60"><div class=mr-auto>&copy; 2024
<a class=link href=https://retrage.github.io/>retrage.github.io</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>hugo-paper</a></footer></body></html>