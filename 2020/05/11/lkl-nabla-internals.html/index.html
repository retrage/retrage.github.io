<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Linux Kernel Library Nabla Containers Internals - retrage.github.io</title>
<meta name=theme-color><meta name=description content="This post describes the design and implementation of Linux Kernel Library Nabla Containers (LKL Nabla), Linux based unikernels as processes. The previous post introduces LKL Nabla and provides how to build and run. Since most of the unikernel work is done by frankenlibc LKL/musl, mainly focus on frankenlibc Solo5 port in this post.
You can find LKL Nabla code at:
https://github.com/retrage/runnc/tree/lkl-musl https://github.com/retrage/frankenlibc/tree/solo5 Modifications to runnc Before diving into frankenlibc code, let’s take a look at the modifications to runnc."><meta name=author content="Akira Moroo"><link rel="preload stylesheet" as=style href=https://retrage.github.io/main.min.css><script defer src=https://retrage.github.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=preload as=image href=https://retrage.github.io/theme.png><link rel=preload as=image href=https://github.com/retrage.png><link rel=preload as=image href=https://retrage.github.io/twitter.svg><link rel=preload as=image href=https://retrage.github.io/github.svg><link rel=preload as=image href=https://retrage.github.io/rss.svg><link rel=icon href=https://retrage.github.io/favicon.ico><link rel=apple-touch-icon href=https://retrage.github.io/apple-touch-icon.png><meta name=generator content="Hugo 0.130.0"><meta itemprop=name content="Linux Kernel Library Nabla Containers Internals"><meta itemprop=description content="This post describes the design and implementation of Linux Kernel Library Nabla Containers (LKL Nabla), Linux based unikernels as processes. The previous post introduces LKL Nabla and provides how to build and run. Since most of the unikernel work is done by frankenlibc LKL/musl, mainly focus on frankenlibc Solo5 port in this post.
You can find LKL Nabla code at:
https://github.com/retrage/runnc/tree/lkl-musl https://github.com/retrage/frankenlibc/tree/solo5 Modifications to runnc Before diving into frankenlibc code, let’s take a look at the modifications to runnc."><meta itemprop=datePublished content="2020-05-11T18:51:01+00:00"><meta itemprop=dateModified content="2020-05-11T18:51:01+00:00"><meta itemprop=wordCount content="1170"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux Kernel Library Nabla Containers Internals"><meta name=twitter:description content="This post describes the design and implementation of Linux Kernel Library Nabla Containers (LKL Nabla), Linux based unikernels as processes. The previous post introduces LKL Nabla and provides how to build and run. Since most of the unikernel work is done by frankenlibc LKL/musl, mainly focus on frankenlibc Solo5 port in this post.
You can find LKL Nabla code at:
https://github.com/retrage/runnc/tree/lkl-musl https://github.com/retrage/frankenlibc/tree/solo5 Modifications to runnc Before diving into frankenlibc code, let’s take a look at the modifications to runnc."></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=https://retrage.github.io/>retrage.github.io</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/>Posts</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/retrage target=_blank rel=me>twitter
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/retrage target=_blank rel=me>github
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://retrage.github.io/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"><article><header class=mb-16><h1 class="!my-0 pb-2.5">Linux Kernel Library Nabla Containers Internals</h1><div class="text-sm antialiased opacity-60"><time>May 11, 2020</time></div></header><section><p>This post describes the design and implementation of Linux Kernel Library Nabla Containers (LKL Nabla), Linux based unikernels as processes. The previous post introduces LKL Nabla and provides how to build and run. Since most of the unikernel work is done by frankenlibc LKL/musl, mainly focus on frankenlibc Solo5 port in this post.</p><p>You can find LKL Nabla code at:</p><ul><li><a href=https://github.com/retrage/runnc/tree/lkl-musl>https://github.com/retrage/runnc/tree/lkl-musl</a></li><li><a href=https://github.com/retrage/frankenlibc/tree/solo5>https://github.com/retrage/frankenlibc/tree/solo5</a></li></ul><h2 id=modifications-to-runnc>Modifications to runnc</h2><p>Before diving into frankenlibc code, let’s take a look at the modifications to runnc.</p><p>When runnc is executed, it initializes devices that will be used by the container. Then, the runtime builds arguments and launches a container as a process.</p><p>What kind of devices will be provided? On current runnc implementation, it can provide only one network device and block device correspondingly. This situation is the same in LKL Nabla.</p><p>A container manager like Docker pulls container an image and extracts to a rootfs as a directory. runnc creates a disk image from the rootfs directory. The disk image format is ISO in Rumprun, but the default file system is ext4 in LKL. Thus, it is switched to ext4 in LKL Nabla.
For the implementation, see <a href=https://github.com/retrage/runnc/blob/lkl-musl/nabla-lib/storage/storage_linux.go><code>CreateExt4()</code></a>.</p><p>Rumprun accepts JSON config from arguments on runtime. The original runnc builds config on container initialization. On the other hand, LKL also allows JSON config on runtime. However, the config format is quite different from Rumprun’s one. LKL Nabla’s runnc creates a config for LKL.
<a href=https://github.com/retrage/runnc/blob/lkl-musl/llruntimes/nabla/runnc-cont/lkl.go>llruntimes/nabla/runnc-cont/lkl.go</a> is the config builder for LKL.</p><p>After the initialization, runnc launches a unikernel process using Solo5 tender like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> = []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>NablaRunBin</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--mem=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>FormatInt</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Memory</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--net:tap=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Tap</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--block:rootfs=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>disk</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>UniKernelBin</span>}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> = append(<span style=color:#a6e22e>args</span>, <span style=color:#e6db74>&#34;__RUMP_FDINFO_NET_tap=4&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> = append(<span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Env</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> = append(<span style=color:#a6e22e>args</span>, <span style=color:#e6db74>&#34;--config&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> = append(<span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>unikernelArgs</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> = append(<span style=color:#a6e22e>args</span>, <span style=color:#e6db74>&#34;--&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>args</span> = append(<span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>NablaRunArgs</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>  <span style=color:#75715e>// snip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Exec</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>NablaRunBin</span>, <span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>newenv</span>)
</span></span></code></pre></div><h2 id=frankenlibc>frankenlibc</h2><p>Now, it’s time to dive into Solo5 port frankenlibc. It was a bunch of tools to run Rumprun unikernel on userspace. It was forked and added LKL/musl support. LKL Nabla uses this fork to run LKL on Solo5.</p><p>Below shows the architecture of frankenlibc.</p><table><thead><tr><th style=text-align:center>frankenlibc Layers</th></tr></thead><tbody><tr><td style=text-align:center>Application</td></tr><tr><td style=text-align:center>musl libc</td></tr><tr><td style=text-align:center>LKL</td></tr><tr><td style=text-align:center>librumpuser</td></tr><tr><td style=text-align:center>franken</td></tr><tr><td style=text-align:center>platform</td></tr><tr><td style=text-align:center>Host</td></tr></tbody></table><p>An application is the top of the 7 layers. The host is the bottom. The host-dependent layer is a platform. The code is located in <a href=https://github.com/retrage/frankenlibc/tree/solo5/platform>platform</a> directory. To port a new host, you will have to add the code to the platform.</p><p>The interfaces that platform code should provide are the same as Linux system calls. Here is the list.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>__libc_start_main</span>(<span style=color:#66d9ef>int</span> (<span style=color:#f92672>*</span>main)(<span style=color:#66d9ef>int</span>,<span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>,<span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>), <span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>argv);
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>_exit</span>(<span style=color:#66d9ef>int</span> status);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>clock_getres</span>(clockid_t clk_id, <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>timespec</span> <span style=color:#f92672>*</span>tp);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>clock_gettime</span>(clockid_t clk_id, <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>timespec</span> <span style=color:#f92672>*</span>tp);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>clock_nanosleep</span>(clockid_t clk_id, <span style=color:#66d9ef>int</span> flags, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>timespec</span> <span style=color:#f92672>*</span>request, <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>timespec</span> <span style=color:#f92672>*</span>remain);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>fcntl</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>int</span> cmd, ...);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>fstat</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>stat</span> <span style=color:#f92672>*</span>st);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>fsync</span>(<span style=color:#66d9ef>int</span> fd);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getpagesize</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getrandom</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>buf, size_t size, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> flags);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>kill</span>(pid_t pid, <span style=color:#66d9ef>int</span> sig);
</span></span><span style=display:flex><span>off_t <span style=color:#a6e22e>lseek</span>(<span style=color:#66d9ef>int</span> fd, off_t offset, <span style=color:#66d9ef>int</span> whence);
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mmap</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>addr, size_t length, <span style=color:#66d9ef>int</span> prot, <span style=color:#66d9ef>int</span> nflags, <span style=color:#66d9ef>int</span> fd, off_t offset);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>munmap</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>addr, size_t length);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>mprotect</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>addr, size_t length, <span style=color:#66d9ef>int</span> prot);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>poll</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>pollfd</span> <span style=color:#f92672>*</span>fds, nfds_t n, <span style=color:#66d9ef>int</span> timeout);
</span></span><span style=display:flex><span>ssize_t <span style=color:#a6e22e>pread</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>buf, size_t count, off_t offset);
</span></span><span style=display:flex><span>ssize_t <span style=color:#a6e22e>preadv</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>iovec</span> <span style=color:#f92672>*</span>iov, <span style=color:#66d9ef>int</span> iovcnt, off_t off);
</span></span><span style=display:flex><span>ssize_t <span style=color:#a6e22e>pwrite</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>buf, size_t count, off_t offset);
</span></span><span style=display:flex><span>ssize_t <span style=color:#a6e22e>pwritev</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>iovec</span> <span style=color:#f92672>*</span>iov, <span style=color:#66d9ef>int</span> iovcnt, off_t off);
</span></span><span style=display:flex><span>ssize_t <span style=color:#a6e22e>read</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>buf, size_t count);
</span></span><span style=display:flex><span>ssize_t <span style=color:#a6e22e>readv</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>iovec</span> <span style=color:#f92672>*</span>iov, <span style=color:#66d9ef>int</span> iovcnt);
</span></span><span style=display:flex><span>ssize_t <span style=color:#a6e22e>write</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>buf, size_t count);
</span></span><span style=display:flex><span>ssize_t <span style=color:#a6e22e>writev</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>iovec</span> <span style=color:#f92672>*</span>iov, <span style=color:#66d9ef>int</span> iovcnt);
</span></span></code></pre></div><p>It looks much larger than that of Solo5 as it provides only 13 hypercalls to the guest OS, but some of them are optional. We need to implement the platform code using the hypercalls for porting LKL/musl to Solo5.</p><h3 id=entry-point>Entry Point</h3><p><code>solo5_start_main()</code> is an entry point in Solo5 guest. A Solo5 tender starts the OS from this function. The argument is a pointer to <code>struct solo5_start_info</code>. It contains <code>cmdline</code>, <code>heap_start</code> and <code>heap_size</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>solo5_start_info</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>cmdline;
</span></span><span style=display:flex><span>    uintptr_t heap_start;
</span></span><span style=display:flex><span>    size_t heap_size;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><code>cmdline</code> is an argument string passed when the unikernel process is launched. As frankenlibc expects <code>envp</code> and <code>argv</code> will be passed from the host, cmdline is parsed into envp and argv in the initialization.
rexec, a launch tool for frankenlibc, can pass a JSON config through a file descriptor. The FD value is shared using the environment variable (e.g. <code>__RUMP_FDINFO_CONFIGJSON</code>). However, this method cannot be applied to Solo5 port because any environment variable cannot be shared with Solo5 guests. Therefore, the JSON config is passed from cmdline as a string in the Solo5 port.</p><p>The other arguments <code>heap_start</code> and <code>heap_size</code> are information about heap provided by the tender. They are used for memory manager initialization. In this Solo5 port, the memory manager is a simple buddy allocator from <a href="http://xenbits.xen.org/gitweb/?p=mini-os.git;a=summary">mini-os</a>. It is used in the <code>mmap()</code>/<code>munmap()</code> <a href=https://github.com/retrage/frankenlibc/blob/solo5/platform/solo5/mmap.c>platform code</a>.</p><h3 id=devices>Devices</h3><p>In *nix system, most of the devices are represented as files and the operations are read/write to the file descriptor. frankenlibc also use this manner in platform code.
rexec opens devices and passes the FD numbers through environment variables (e.g. <code>__RUMP_FDINFO_NET_tap</code>). This behavior is the same as the JSON config. The franken layer registers devices using the FD info in <a href=https://github.com/retrage/frankenlibc/blob/solo5/franken/init/fdinit.c><code>fdinit()</code></a>.</p><p>In Solo5, devices attached at runtime must be specified at build time. When building a guest, a JSON format config called Application Manifest <code>manifest.json</code> must be supplied. It declares user-specified devices. In contrast to Solo5, frankenlibc rexec can specify devices at run time. As described before, current runnc can deal with one block device and one network device. Therefore, the Solo5 port uses fixed <code>manifest.json</code> that specifies one block device <code>rootfs</code> and one network device <code>tap</code>. Below is the config.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;solo5.manifest&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;devices&#34;</span>:
</span></span><span style=display:flex><span>  [
</span></span><span style=display:flex><span>    { <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;rootfs&#34;</span>, <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;BLOCK_BASIC&#34;</span> },
</span></span><span style=display:flex><span>    { <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;tap&#34;</span>, <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;NET_BASIC&#34;</span> }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A device in Solo5 is represented by <code>solo5_handle_t</code>, not by the file descriptor. In the frankenlibc Solo5 port, as the devices are fixed, it assigns a virtual FD number to the Solo5 device handle.</p><p>Solo5 provides interfaces for reading/writing devices and console. In <code>read()</code>/<code>write()</code> platform code, it identifies the FD number and call appropriate hypercalls.</p><p><code>poll()</code>/<code>clock_nanosleep()</code> are used for waiting network packets. Each network device has file descriptor <code>pollfd</code> to store polling state in frankenlibc. For Solo5 port, <code>solo5_yield()</code> is used to implement <code>poll()</code>/<code>clock_nanosleep()</code> The behavior is almost the same as the Linux port.</p><p>In <code>clock_nanosleep()</code>, it calls <code>solo5_yield()</code> and if the network handle is set on <code>ready_set</code>, it updates the <code>pollfd.revents</code> and wake the associated thread. In <code>poll()</code>, it sleeps until <code>timeout</code> and sets FD&rsquo;s <code>revents</code> if <code>pollfd.revents</code> is updated.</p><h2 id=conclusion>Conclusion</h2><p>This post summarized LKL Nabla internals. The most of implementations are straight forward thanks to frankenlibc platform-independent interfaces and simple Solo5 hypercalls. However, since LKL has different interfaces with Rumprun, patches to runnc for LKL port is quite large. It will be better to have a switching option to change between Rumprun and LKL on runnc.</p></section><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://retrage.github.io/2020/06/15/9pfspkg.html/><span class=mr-1.5>←</span><span>UEFI向け9P File Systemを作ってクラウドからネットワークブートできるようにした</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://retrage.github.io/2020/05/06/edk2-error-level.html/><span>EDK2におけるDebugPrintErrorLevel</span><span class=ml-1.5>→</span></a></nav></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2024
<a class=link href=https://retrage.github.io/>retrage.github.io</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>✎ Paper</a></footer></body></html>